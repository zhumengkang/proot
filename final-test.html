<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆå¯†ç ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .code { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸš€ æœ€ç»ˆå¯†ç ç³»ç»Ÿæµ‹è¯•</h1>
    
    <div id="loadingStatus" class="info">æ­£åœ¨åŠ è½½é…ç½®...</div>
    <div id="results"></div>
    
    <button onclick="runDetailedTests()">è¿è¡Œè¯¦ç»†æµ‹è¯•</button>
    <button onclick="testPasswordVerification()">æµ‹è¯•å¯†ç éªŒè¯</button>
    
    <!-- å…³é”®ï¼šæŒ‰æ­£ç¡®é¡ºåºåŠ è½½è„šæœ¬ -->
    <script src="config/master-config.js"></script>
    <script src="js/auth-config.js"></script>
    <script src="js/password.js"></script>

    <script>
        // ç­‰å¾…é…ç½®å®Œå…¨åŠ è½½
        async function waitForConfig() {
            let attempts = 0;
            while ((!window.MASTER_CONFIG || !window.MASTER_CONFIG_READY) && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            return window.MASTER_CONFIG && window.MASTER_CONFIG_READY;
        }
        
        async function checkLoadingStatus() {
            const status = document.getElementById('loadingStatus');
            
            if (window.MASTER_CONFIG) {
                if (window.MASTER_CONFIG_READY) {
                    status.innerHTML = 'âœ… ä¸»é…ç½®å·²åŠ è½½å¹¶åˆå§‹åŒ–å®Œæˆ';
                    status.className = 'success';
                    runQuickTests();
                } else {
                    status.innerHTML = 'â³ ä¸»é…ç½®å·²åŠ è½½ï¼Œç­‰å¾…åˆå§‹åŒ–å®Œæˆ...';
                    status.className = 'warning';
                    setTimeout(checkLoadingStatus, 500);
                }
            } else {
                status.innerHTML = 'âŒ ä¸»é…ç½®æœªåŠ è½½';
                status.className = 'error';
                setTimeout(checkLoadingStatus, 500);
            }
        }
        
        async function runQuickTests() {
            const results = document.getElementById('results');
            const tests = [];
            
            try {
                // å¿«é€Ÿæ£€æŸ¥
                tests.push(`âœ… ä¸»é…ç½®å­˜åœ¨: ${!!window.MASTER_CONFIG}`);
                tests.push(`âœ… ä¸»é…ç½®å°±ç»ª: ${!!window.MASTER_CONFIG_READY}`);
                tests.push(`âœ… AUTH_CONFIGå­˜åœ¨: ${!!window.AUTH_CONFIG}`);
                tests.push(`âœ… å¯†ç è®¾ç½®: ${window.AUTH_CONFIG?.password || 'æœªè®¾ç½®'}`);
                tests.push(`âœ… å¯ç”¨çŠ¶æ€: ${window.AUTH_CONFIG?.enabled}`);
                
                // å…³é”®å‡½æ•°æ£€æŸ¥
                const isProtected = window.isPasswordProtected ? window.isPasswordProtected() : 'undefined';
                tests.push(`${isProtected ? 'âœ…' : 'âŒ'} isPasswordProtected: ${isProtected}`);
                
                const isRequired = window.isPasswordRequired ? window.isPasswordRequired() : 'undefined';
                tests.push(`${!isRequired ? 'âœ…' : 'âŒ'} isPasswordRequired: ${isRequired}`);
                
                // æ£€æŸ¥å“ˆå¸Œ
                if (typeof window.getPasswordHash === 'function') {
                    const hash = await window.getPasswordHash();
                    tests.push(`${hash ? 'âœ…' : 'âŒ'} å¯†ç å“ˆå¸Œ: ${hash ? hash.substring(0, 16) + '...' : 'æœªç”Ÿæˆ'}`);
                }
                
            } catch (error) {
                tests.push(`âŒ æµ‹è¯•å‡ºé”™: ${error.message}`);
            }
            
            results.innerHTML = `
                <div class="test-result ${tests.some(t => t.includes('âŒ')) ? 'warning' : 'success'}">
                    <h3>ğŸ“Š å¿«é€Ÿæ£€æŸ¥ç»“æœ</h3>
                    <div class="code">${tests.join('\n')}</div>
                </div>
            `;
        }
        
        async function runDetailedTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">æ­£åœ¨è¿è¡Œè¯¦ç»†æµ‹è¯•...</div>';
            
            const configReady = await waitForConfig();
            
            if (!configReady) {
                results.innerHTML = '<div class="error">âŒ é…ç½®åŠ è½½è¶…æ—¶ï¼Œæ— æ³•è¿›è¡Œæµ‹è¯•</div>';
                return;
            }
            
            const tests = [
                '=== é…ç½®æ£€æŸ¥ ===',
                `ä¸»é…ç½®å¯¹è±¡: ${JSON.stringify(window.MASTER_CONFIG, null, 2)}`,
                '',
                '=== AUTH_CONFIGæ£€æŸ¥ ===',
                `username: ${window.AUTH_CONFIG?.username}`,
                `password: ${window.AUTH_CONFIG?.password}`,
                `enabled: ${window.AUTH_CONFIG?.enabled}`,
                `passwordHash: ${window.AUTH_CONFIG?.passwordHash ? window.AUTH_CONFIG.passwordHash.substring(0, 16) + '...' : 'æœªè®¾ç½®'}`,
                '',
                '=== å‡½æ•°æ£€æŸ¥ ===',
            ];
            
            try {
                const isProtected = window.isPasswordProtected();
                tests.push(`isPasswordProtected(): ${isProtected}`);
                
                const isRequired = window.isPasswordRequired();
                tests.push(`isPasswordRequired(): ${isRequired}`);
                
                if (typeof window.getPasswordHash === 'function') {
                    const hash = await window.getPasswordHash();
                    tests.push(`getPasswordHash(): ${hash}`);
                }
                
            } catch (error) {
                tests.push(`âŒ å‡½æ•°æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
            
            results.innerHTML = `
                <div class="test-result info">
                    <h3>ğŸ” è¯¦ç»†æµ‹è¯•ç»“æœ</h3>
                    <div class="code">${tests.join('\n')}</div>
                </div>
            `;
        }
        
        async function testPasswordVerification() {
            const results = document.getElementById('results');
            
            try {
                results.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•å¯†ç éªŒè¯...</div>';
                
                if (typeof window.verifyPassword === 'function') {
                    const testPassword = '123qwe!@#QWE';
                    const isValid = await window.verifyPassword(testPassword);
                    
                    const result = isValid ? 
                        `âœ… å¯†ç éªŒè¯æˆåŠŸï¼å¯†ç  "${testPassword}" éªŒè¯é€šè¿‡` :
                        `âŒ å¯†ç éªŒè¯å¤±è´¥ï¼å¯†ç  "${testPassword}" éªŒè¯æœªé€šè¿‡`;
                    
                    results.innerHTML = `
                        <div class="test-result ${isValid ? 'success' : 'error'}">
                            <h3>ğŸ” å¯†ç éªŒè¯ç»“æœ</h3>
                            <div>${result}</div>
                        </div>
                    `;
                } else {
                    results.innerHTML = '<div class="error">âŒ verifyPassword å‡½æ•°ä¸å­˜åœ¨</div>';
                }
            } catch (error) {
                results.innerHTML = `<div class="error">âŒ å¯†ç éªŒè¯å‡ºé”™: ${error.message}</div>`;
            }
        }
        
        // é¡µé¢åŠ è½½åå¼€å§‹æ£€æŸ¥
        setTimeout(checkLoadingStatus, 100);
    </script>
</body>
</html>