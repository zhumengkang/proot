# LibreTV 密码配置完整指南

## 🎯 快速修改密码

### 只需修改一个文件！

**文件位置**: `config/master-config.js`

**修改步骤**:
1. 打开 `config/master-config.js` 文件
2. 找到第8行的 `password` 字段
3. 将 `'123qwe!@#QWE'` 改为您的新密码
4. 保存文件

```javascript
const MASTER_CONFIG = {
    // 🔐 核心认证配置（只需要在这里修改）
    auth: {
        username: 'admin',                    // 用户名
        password: '您的新密码',              // 🔥 在这里修改密码
        enabled: true,                        // 是否启用密码保护
        sessionDuration: 90 * 24 * 60 * 60 * 1000,  // 90天
        maxLoginAttempts: 5,                  // 最大尝试次数
        lockoutDuration: 30 * 60 * 1000       // 锁定时间30分钟
    },
    // ... 其他配置
};
```

**✨ 就这么简单！** 系统会自动：
- 计算新密码的SHA-256哈希值
- 更新所有前端和后端组件
- 同步所有代理服务的认证

---

## 🏗️ 系统架构说明

### 📁 核心文件结构

```
LibreTV-main/
├── config/
│   ├── master-config.js         # 🎯 主配置文件（唯一修改点）
│   └── config-loader.mjs        # Node.js配置加载器
├── js/
│   ├── auth-config.js           # 前端认证配置（自动同步）
│   ├── password.js              # 密码验证逻辑
│   └── proxy-auth.js            # 代理认证处理
├── index.html                   # 主页面
├── player.html                  # 播放器页面
└── 各种代理文件/                # 自动从主配置读取
```

### 🔄 配置同步机制

```mermaid
graph TD
    A[config/master-config.js] --> B[自动计算SHA-256哈希]
    B --> C[js/auth-config.js 同步配置]
    C --> D[js/password.js 验证密码]
    C --> E[js/proxy-auth.js 代理认证]
    A --> F[config-loader.mjs Node.js加载]
    F --> G[所有服务端代理文件]
    G --> H[netlify/functions/proxy.mjs]
    G --> I[api/proxy/[...path].mjs]
    G --> J[server.mjs]
    G --> K[simple-proxy.js]
```

---

## 🔐 密码系统工作原理

### 1. 主配置初始化
```javascript
// 页面加载时自动执行
initializeConfig() → 计算密码哈希 → 设置MASTER_CONFIG_READY标记
```

### 2. 前端认证流程
```javascript
// 用户访问页面
isPasswordProtected() → 检查配置是否就绪 → 显示密码框
verifyPassword() → 计算输入密码哈希 → 与主配置哈希对比 → 验证成功/失败
```

### 3. 代理认证流程
```javascript
// API请求认证
getPasswordHash() → 从主配置获取哈希 → 添加到请求URL参数 → 后端验证
```

---

## ⚙️ 详细配置选项

### 认证配置 (auth)

| 配置项 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `username` | 登录用户名 | `'admin'` | `'myuser'` |
| `password` | 主密码（明文） | `'123qwe!@#QWE'` | `'mySecurePassword123'` |
| `enabled` | 是否启用密码保护 | `true` | `false` |
| `sessionDuration` | 会话有效期（毫秒） | `90天` | `7 * 24 * 60 * 60 * 1000` |
| `maxLoginAttempts` | 最大尝试次数 | `5` | `3` |
| `lockoutDuration` | 锁定时间（毫秒） | `30分钟` | `60 * 60 * 1000` |

### 代理配置 (proxy)

| 配置项 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `debug` | 调试模式 | `false` | `true` |
| `cacheEnabled` | 启用缓存 | `true` | `false` |
| `cacheTTL` | 缓存时间（秒） | `86400` | `3600` |
| `maxRecursion` | 最大递归层数 | `5` | `10` |
| `timeout` | 请求超时（毫秒） | `10000` | `5000` |

### UI配置 (ui)

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `title` | 应用标题 | `'LibreTV'` |
| `loginTitle` | 登录弹窗标题 | `'LibreTV 访问验证'` |
| `loginPrompt` | 登录提示文字 | `'请输入访问密码'` |

---

## 🛠️ 高级配置示例

### 示例1：短会话，严格安全
```javascript
const MASTER_CONFIG = {
    auth: {
        username: 'admin',
        password: 'MyVerySecurePassword2024!',
        enabled: true,
        sessionDuration: 2 * 60 * 60 * 1000,      // 2小时
        maxLoginAttempts: 3,                       // 3次尝试
        lockoutDuration: 60 * 60 * 1000           // 锁定1小时
    }
};
```

### 示例2：开发环境，宽松设置
```javascript
const MASTER_CONFIG = {
    auth: {
        username: 'dev',
        password: 'dev123',
        enabled: true,
        sessionDuration: 24 * 60 * 60 * 1000,     // 24小时
        maxLoginAttempts: 10,                      // 10次尝试
        lockoutDuration: 5 * 60 * 1000            // 锁定5分钟
    },
    proxy: {
        debug: true,                               // 启用调试
        cacheEnabled: false,                       // 禁用缓存
        timeout: 30000                             // 30秒超时
    }
};
```

### 示例3：禁用密码保护（不推荐）
```javascript
const MASTER_CONFIG = {
    auth: {
        enabled: false,                            // 🚨 禁用密码保护
        // 其他配置...
    }
};
```

---

## 🔍 故障排除

### 问题1：密码验证失败
**可能原因**：
- 密码输入错误
- 浏览器缓存问题
- 哈希计算失败

**解决方案**：
1. 确认密码拼写正确
2. 清除浏览器缓存和Cookie
3. 打开浏览器控制台查看错误信息
4. 访问 `debug-auth.html` 进行诊断

### 问题2：配置不生效
**可能原因**：
- 文件保存问题
- 脚本加载顺序错误
- 语法错误

**解决方案**：
1. 确认文件已保存
2. 检查 `master-config.js` 语法是否正确
3. 查看浏览器控制台是否有JavaScript错误

### 问题3：代理认证失败
**可能原因**：
- 主配置未正确加载到后端
- 哈希计算不一致

**解决方案**：
1. 重启服务器（如果使用Node.js）
2. 检查服务器日志
3. 确认代理文件是否正确引用了 `config-loader.mjs`

---

## 🧪 测试工具

### 1. 基础测试
访问 `test-password-simple.html` 进行快速测试

### 2. 详细诊断
访问 `debug-auth.html` 查看完整的诊断信息

### 3. 最终验证
访问 `final-test.html` 进行全面的系统测试

---

## 📝 最佳实践

### 1. 密码安全
- ✅ 使用强密码（至少12位，包含大小写字母、数字、特殊字符）
- ✅ 定期更换密码
- ❌ 不要使用简单密码如 `123456`、`password`

### 2. 配置管理
- ✅ 修改密码后测试验证功能
- ✅ 备份配置文件
- ✅ 在生产环境中启用密码保护

### 3. 部署注意事项
- ✅ 确保 `config/master-config.js` 文件权限安全
- ✅ 在静态部署时注意文件可读性
- ⚠️ 静态部署中明文密码会在客户端可见，仅在可信环境使用

---

## 🔄 密码修改完整流程

### 步骤详解

1. **打开配置文件**
   ```bash
   # 使用任何文本编辑器
   code config/master-config.js
   # 或
   notepad config/master-config.js
   ```

2. **修改密码**
   ```javascript
   // 第8行，修改这里
   password: '您的新密码',
   ```

3. **保存文件**
   - Windows: `Ctrl + S`
   - Mac: `Cmd + S`

4. **验证更改**
   - 刷新浏览器页面
   - 尝试使用新密码登录

5. **确认成功**
   - 检查是否能正常访问
   - 测试搜索功能是否正常

---

## 📋 配置检查清单

- [ ] `config/master-config.js` 中密码已修改
- [ ] 文件已保存
- [ ] 浏览器缓存已清除
- [ ] 新密码能够成功登录
- [ ] 搜索功能正常工作
- [ ] 视频播放功能正常

---

## 🆘 紧急恢复

如果配置出现问题，可以使用以下默认配置：

```javascript
const MASTER_CONFIG = {
    auth: {
        username: 'admin',
        password: '123qwe!@#QWE',
        enabled: true,
        sessionDuration: 90 * 24 * 60 * 60 * 1000,
        maxLoginAttempts: 5,
        lockoutDuration: 30 * 60 * 1000
    },
    proxy: {
        debug: false,
        cacheEnabled: true,
        cacheTTL: 86400,
        maxRecursion: 5,
        timeout: 10000,
        userAgents: [
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        ]
    },
    ui: {
        title: 'LibreTV',
        loginTitle: 'LibreTV 访问验证',
        loginPrompt: '请输入访问密码'
    }
};
```

